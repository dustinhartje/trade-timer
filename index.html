<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Timer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
        }
        h1, h2 {
            text-align: center;
            color: #444;
        }
        .date-time-display {
            text-align: center;
            font-size: 1.15rem;
            color: #333;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        .container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-group {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            justify-content: center;
        }
        .input-group div {
            display: flex;
            flex-direction: column;
        }
        .input-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .input-group input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            width: 150px;
        }
        .strategy {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fafafa;
        }
        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .strategy-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        .target-price {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .hours-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .hour-toggle {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
        }
        /* Valid/Invalid Hour Highlighting */
        .hour-valid-long {
            background-color: #d4edda; /* Light Green */
            border-color: #c3e6cb;
            color: #155724;
        }
        .hour-valid-short {
            background-color: #f8d7da; /* Light Red (for background), but will use bright red for text */
            border-color: #f5c6cb;
            color: #dc3545; /* Use Bootstrap "danger" red */
        }
        .hour-invalid {
            background-color: #eee !important; /* Light gray */
            border-color: #d3d3d3 !important;
            color: #888 !important;
        }
        .highlight-green {
            background-color: #28a745 !important; /* Bright Green */
            color: white;
        }
        .highlight-red {
            background-color: #dc3545 !important; /* Bright Red */
            color: white;
        }
        .footer-link {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div class="date-time-display" id="date-time-display">
        <!-- Current date and time will be rendered here -->
    </div>

    <div class="container">
        <h1>Trade Timer ‚è±Ô∏è</h1>

        <div class="input-group">
            <div>
                <label for="e1h9ema">e1h9ema</label>
                <input type="number" id="e1h9ema" placeholder="e.g., 4550.75" step="0.01">
            </div>
            <div>
                <label for="e1h20ema">e1h20ema</label>
                <input type="number" id="e1h20ema" placeholder="e.g., 4560.25" step="0.01">
            </div>
            <div>
                <label for="open-price">Open Price</label>
                <input type="number" id="open-price" placeholder="e.g., 4552.50" step="0.01">
            </div>
        </div>

        <div id="strategies-container"></div>
        
        <div class="footer-link">
             <a href="#" id="view-all-hours-link">View All Hour Validity</a>
        </div>
    </div>

    <!-- Buzzer Audio (hidden) -->
    <audio id="buzzer-audio" preload="auto">
        <source src="tickingbuzzer_28sec.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =================== üïí DATE & TIME DISPLAY ===================
        const dateTimeDisplay = document.getElementById('date-time-display');
        function updateDateTime() {
            const now = new Date();
            const dayOfWeek = now.toLocaleDateString('en-US', { weekday: 'long' });
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            dateTimeDisplay.textContent = `${dayOfWeek}, ${dateStr} ‚Äî ${timeStr}`;
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // =================================================================
        // ===== ‚öôÔ∏è CONFIGURATION: MODIFY STRATEGIES AND HOURS HERE ‚öôÔ∏è =====
        // =================================================================

        /**
         * Define your trading strategies here.
         * 'name': The display name of the strategy.
         * 'type': 'long' or 'short'.
         * 'offset': The integer value for the calculation.
         * 'emaKey': Which EMA to use, must match the input id (e.g., "e1h9ema" or "e1h20ema").
         */
        const strategies = [
            { name: "IRA Bounce", type: "long", offset: 0, emaKey: "e1h9ema" },
            { name: "IRA Reject", type: "short", offset: 40, emaKey: "e1h9ema" },
            { name: "Apex Bounce", type: "long", offset: 0, emaKey: "e1h20ema" },
            { name: "Apex Reject", type: "short", offset: 40, emaKey: "e1h20ema" }
        ];

        /**
         * Define the default valid trading hours for each strategy.
         * The keys are the strategy names, matching the 'name' field above.
         * The values are objects with weekdays as keys.
         * Each weekday has an array of valid hours (from 9 to 15).
         */
        let strategyHours = {
            "IRA Bounce": {
                "Monday": [12],
                "Tuesday": [11, 13],
                "Wednesday": [10, 13, 14],
                "Thursday": [9],
                "Friday": [9, 10]
            },
            "IRA Reject": {
                "Monday": [12],
                "Tuesday": [9],
                "Wednesday": [10],
                "Thursday": [9, 10],
                "Friday": [9, 10]
            },
            "Apex Bounce": {
                "Monday": [],
                "Tuesday": [11, 13],
                "Wednesday": [10, 14],
                "Thursday": [9],
                "Friday": [9, 10]
            },
            "Apex Reject": {
                "Monday": [9],
                "Tuesday": [9],
                "Wednesday": [9, 10],
                "Thursday": [9, 10],
                "Friday": [10]
            }
        };

        // =================================================================
        // =================== üë®‚Äçüíª CORE APPLICATION LOGIC üë®‚Äçüíª ====================
        // =================================================================
        
        const emaInputs = {
            "e1h9ema": document.getElementById('e1h9ema'),
            "e1h20ema": document.getElementById('e1h20ema')
        };
        const openPriceInput = document.getElementById('open-price');
        const strategiesContainer = document.getElementById('strategies-container');

        const calculateTargetPrice = (ema, offset, type) => {
            if (type === 'long') {
                const roundedUp = Math.ceil(ema * 4) / 4;
                return roundedUp - (offset / 4);
            } else { // short
                const roundedDown = Math.floor(ema * 4) / 4;
                return roundedDown + (offset / 4);
            }
        };
        
        const renderStrategies = () => {
            strategiesContainer.innerHTML = '';
            const emaValues = {};
            for (const key in emaInputs) {
                emaValues[key] = parseFloat(emaInputs[key].value);
            }
            const openPrice = parseFloat(openPriceInput.value);
            const now = new Date();
            const currentDay = now.toLocaleString('en-US', { weekday: 'long' });
            const currentHour = now.getHours();

            strategies.forEach(strategy => {
                let targetPrice = 'N/A';
                let highlightClass = '';

                const ema = emaValues[strategy.emaKey];

                // Determine if this hour is valid for this strategy
                const validHoursForDay = strategyHours[strategy.name]?.[currentDay] || [];
                const isCurrentHourValid = validHoursForDay.includes(currentHour);

                if (!isNaN(ema)) {
                    targetPrice = calculateTargetPrice(ema, strategy.offset, strategy.type);

                    // Only highlight if both price criteria is met and this hour is valid
                    if (!isNaN(openPrice) && isCurrentHourValid) {
                        if (strategy.type === 'long' && openPrice > targetPrice) {
                            highlightClass = 'highlight-green';
                        } else if (strategy.type === 'short' && openPrice < targetPrice) {
                            highlightClass = 'highlight-red';
                        }
                    }
                    targetPrice = targetPrice.toFixed(2);
                }
                
                const strategyDiv = document.createElement('div');
                strategyDiv.className = 'strategy';

                // Create Header
                const header = document.createElement('div');
                header.className = 'strategy-header';
                header.innerHTML = `<h3>${strategy.name} <small>(${strategy.type}, offset:${strategy.offset}, EMA: ${strategy.emaKey})</small></h3>
                                    <span class="target-price ${highlightClass}">Target: ${targetPrice}</span>`;
                
                // Create Hours Container
                const hoursContainer = document.createElement('div');
                hoursContainer.className = 'hours-container';
                
                for (let hour = 9; hour <= 15; hour++) {
                    if (hour >= currentHour) { // Only show current and future hours
                        const isValid = validHoursForDay.includes(hour);
                        let hourClass = 'hour-toggle ';
                        if (isValid) {
                            hourClass += strategy.type === 'long' ? 'hour-valid-long' : 'hour-valid-short';
                        } else {
                            hourClass += 'hour-invalid';
                        }
                        const hourToggle = document.createElement('div');
                        hourToggle.className = hourClass;
                        hourToggle.textContent = `${hour}:00`;
                        hourToggle.dataset.strategy = strategy.name;
                        hourToggle.dataset.hour = hour;
                        hourToggle.dataset.day = currentDay;
                        hoursContainer.appendChild(hourToggle);
                    }
                }
                
                strategyDiv.appendChild(header);
                strategyDiv.appendChild(hoursContainer);
                strategiesContainer.appendChild(strategyDiv);
            });
        };

        const toggleHourValidity = (e) => {
            if (!e.target.classList.contains('hour-toggle')) return;
            
            const { strategy, hour, day } = e.target.dataset;
            const hourNum = parseInt(hour, 10);
            const dayHours = strategyHours[strategy]?.[day];

            if (!dayHours) return;

            const hourIndex = dayHours.indexOf(hourNum);
            if (hourIndex > -1) {
                dayHours.splice(hourIndex, 1); // Remove hour if it exists
            } else {
                dayHours.push(hourNum); // Add hour if it doesn't
                dayHours.sort((a, b) => a - b); // Keep the array sorted
            }
            
            renderStrategies(); // Re-render to show the change
        };

        const clearInputsAtTopOfTheHour = () => {
            const now = new Date();
            if (now.getMinutes() === 0 && now.getSeconds() === 0) {
                emaInputs["e1h9ema"].value = '';
                emaInputs["e1h20ema"].value = '';
                openPriceInput.value = '';
                renderStrategies();
            }
        };

        // ====== üîä BUZZER SOUND LOGIC =======
        const buzzer = document.getElementById('buzzer-audio');
        let hasBuzzedThisHour = false;
        function checkBuzzer() {
            const now = new Date();
            // Play at xx:59:30-xx:59:34 (for a 28s ticking buzzer)
            if (now.getMinutes() === 59 && now.getSeconds() >= 30 && now.getSeconds() < 34) {
                if (!hasBuzzedThisHour) {
                    // Play buzzer (rewind in case)
                    try {
                        buzzer.currentTime = 0;
                        buzzer.play();
                    } catch (e) {
                        // Ignore play errors (browser may block until user interacts)
                    }
                    hasBuzzedThisHour = true;
                }
            } else if (now.getMinutes() !== 59) {
                hasBuzzedThisHour = false; // Reset for next hour
            }
        }

        // Event Listeners
        emaInputs["e1h9ema"].addEventListener('input', renderStrategies);
        emaInputs["e1h20ema"].addEventListener('input', renderStrategies);
        openPriceInput.addEventListener('input', renderStrategies);
        strategiesContainer.addEventListener('click', toggleHourValidity);

        // Initial render
        renderStrategies();
        
        // Check to clear inputs every second
        setInterval(clearInputsAtTopOfTheHour, 1000);
        
        // Refresh the entire view every minute to update the displayed hours
        setInterval(renderStrategies, 60000); 

        // Buzzer check every 250ms for precision
        setInterval(checkBuzzer, 250);

        // ==============================
        // View All Hour Validity popup
        // ==============================
        function openAllHourValidityWindow() {
            // Compose HTML for all strategies, days, and hours
            const weekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
            let html = `
                <html>
                <head>
                    <title>All Hour Validity</title>
                    <style>
                        body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background: #fff; color: #232; padding: 20px; }
                        table { border-collapse: collapse; margin-bottom: 35px; width: 100%; }
                        th, td { border: 1px solid #ddd; padding: 6px 9px; text-align: center; }
                        th { background: #f4f4f9; }
                        .valid-long { background: #d4edda; color: #155724; }
                        .valid-short { background: #f8d7da; color: #dc3545; }
                        .invalid { background: #eee; color: #888; }
                        h2 { margin-top: 32px; }
                        .offset { font-size: 0.9em; color: #888; }
                    </style>
                </head>
                <body>
                    <h1>All Hour Validity</h1>
            `;
            for (const strategy of strategies) {
                html += `<h2>${strategy.name} <span class="offset">(${strategy.type}, offset:${strategy.offset}, EMA: ${strategy.emaKey})</span></h2>`;
                html += `<table><thead><tr><th>Day</th>`;
                for (let hour = 9; hour <= 15; hour++) {
                    html += `<th>${hour}:00</th>`;
                }
                html += `</tr></thead><tbody>`;
                for (const day of weekdays) {
                    html += `<tr><td>${day}</td>`;
                    const validHours = strategyHours[strategy.name]?.[day] || [];
                    for (let hour = 9; hour <= 15; hour++) {
                        const valid = validHours.includes(hour);
                        let tdClass = "";
                        if (valid) {
                            tdClass = strategy.type === "long" ? "valid-long" : "valid-short";
                        } else {
                            tdClass = "invalid";
                        }
                        html += `<td class="${tdClass}">${valid ? "‚úì" : "‚úó"}</td>`;
                    }
                    html += `</tr>`;
                }
                html += `</tbody></table>`;
            }
            html += `
                    <p style="font-size:0.85em;color:#888;">Green ‚úì = valid hour (long), Red ‚úì = valid hour (short), Gray ‚úó = invalid hour for that strategy and day.</p>
                    <button onclick="window.close()" style="margin: 12px auto; display: block; padding: 7px 24px; border-radius: 7px; background: #eee; border: 1px solid #ccc; cursor: pointer;">Close</button>
                </body></html>
            `;
            const win = window.open('', '_blank', 'width=900,height=900,scrollbars=yes');
            win.document.write(html);
            win.document.close();
        }

        document.getElementById('view-all-hours-link').addEventListener('click', function(e) {
            e.preventDefault();
            openAllHourValidityWindow();
        });

    });
    </script>
</body>
</html>
